<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Idle RPG Game Tester</title>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        .section { margin-bottom: 2em; }
        label, input { font-size: 1em; }
        button { margin: 0.5em; padding: 0.5em 1em; font-size: 1em; }
        #output { margin-top: 1em; white-space: pre; background: #f4f4f4; padding: 1em; border-radius: 5px; }
        #status { font-weight: bold; margin-left: 1em; }
        .status-ok { color: green; }
        .status-fail { color: red; }
        .statbox { display: inline-block; min-width: 120px; margin-right: 2em; }
        .inv-table { border-collapse: collapse; margin-top: 1em; }
        .inv-table th, .inv-table td { border: 1px solid #ccc; padding: 4px 8px; }
        .inv-table th { background: #eee; }
        .map-table { border-collapse: collapse; margin-top: 1em; }
        .map-table td { width: 32px; height: 32px; text-align: center; border: 1px solid #bbb; font-size: 1.2em; }
        .errorbox { color: red; margin-top: 1em; }
    </style>
</head>
<body>
    <h1>Idle RPG Game Tester</h1>
    <div class="section">
        <label>API-URL: <input id="apiurl" value="http://localhost:8000" size="40" oninput="checkApiStatus()"></label>
        <span id="status" class="status-fail">Nicht verbunden</span>
        <button onclick="checkApiStatus()">Verbindung testen</button>
    </div>
    <div class="section">
        <button onclick="callApi('GET', '/state')">Spielstand abrufen</button>
        <button onclick="callApi('POST', '/tick')">Tick ausf√ºhren</button>
        <button onclick="callApi('POST', '/reset')">Spiel zur√ºcksetzen</button>
    </div>
    <div class="section" id="gameinfo"></div>
    <div class="section" id="gamemap"></div>
    <div id="output">W√§hle eine Aktion‚Ä¶</div>
    <div id="errorbox" class="errorbox"></div>
    <script>
    async function callApi(method, path) {
        const url = document.getElementById('apiurl').value + path;
        let resp, data, errorMsg = '';
        try {
            resp = await fetch(url, { method });
            const contentType = resp.headers.get('content-type') || '';
            if (resp.ok && contentType.includes('application/json')) {
                data = await resp.json();
                setStatus(true);
                showGameInfo(data);
                showGameMap(data);
                errorMsg = '';
            } else {
                setStatus(resp.ok);
                let text = await resp.text();
                errorMsg = `Fehler: HTTP ${resp.status} (${resp.statusText})\nContent-Type: ${contentType}\nAntwort: ${text}`;
                data = { error: errorMsg };
                showGameInfo(null);
                showGameMap(null);
            }
        } catch (e) {
            data = { error: e.toString() };
            setStatus(false);
            showGameInfo(null);
            showGameMap(null);
            errorMsg = `Fehler: ${e.toString()}`;
        }
        document.getElementById('output').textContent = JSON.stringify(data, null, 2);
        document.getElementById('errorbox').textContent = errorMsg;
    }
    async function checkApiStatus() {
        const url = document.getElementById('apiurl').value + '/state';
        let ok = false, errorMsg = '';
        try {
            const resp = await fetch(url);
            const contentType = resp.headers.get('content-type') || '';
            if (resp.ok && contentType.includes('application/json')) {
                const data = await resp.json();
                showGameInfo(data);
                showGameMap(data);
                ok = true;
                errorMsg = '';
            } else {
                let text = await resp.text();
                errorMsg = `Fehler: HTTP ${resp.status} (${resp.statusText})\nContent-Type: ${contentType}\nAntwort: ${text}`;
                showGameInfo(null);
                showGameMap(null);
                ok = resp.ok;
            }
        } catch (e) {
            ok = false;
            showGameInfo(null);
            showGameMap(null);
            errorMsg = `Fehler: ${e.toString()}`;
        }
        setStatus(ok);
        document.getElementById('errorbox').textContent = errorMsg;
    }
    function setStatus(ok) {
        const status = document.getElementById('status');
        if (ok) {
            status.textContent = 'Verbunden';
            status.className = 'status-ok';
        } else {
            status.textContent = 'Nicht verbunden';
            status.className = 'status-fail';
        }
    }
    function showGameInfo(data) {
        const box = document.getElementById('gameinfo');
        if (!data || data.error) {
            box.innerHTML = '<span style="color:red">Keine Spieldaten verf√ºgbar.</span>';
            return;
        }
        let html = '';
        // Spieler-Status
        if (data.player) {
            html += `<div class="statbox"><b>Spieler</b><br>HP: ${data.player.hp}<br>Gold: ${data.player.gold}<br>Level: ${data.player.level || '-'}<br>XP: ${data.player.xp || '-'}<br>Runde: ${data.round || '-'}<br></div>`;
        }
        // Gegner-Status
        if (data.opponent) {
            html += `<div class="statbox"><b>Gegner</b><br>Name: ${data.opponent.name || '-'}<br>HP: ${data.opponent.hp || '-'}<br>Typ: ${data.opponent.type || '-'}<br></div>`;
        }
        // Inventar
        if (data.inventory && Array.isArray(data.inventory)) {
            html += '<div><b>Inventar</b><table class="inv-table"><tr><th>Item</th><th>Menge</th></tr>';
            for (const item of data.inventory) {
                html += `<tr><td>${item.name || item.id}</td><td>${item.amount || 1}</td></tr>`;
            }
            html += '</table></div>';
        }
        box.innerHTML = html;
    }
    function showGameMap(data) {
        const box = document.getElementById('gamemap');
        if (!data || !data.tiles || !data.width || !data.height) {
            box.innerHTML = '';
            return;
        }
        // Map als 2D-Array aufbauen
        const map = Array.from({length: data.height}, () => Array(data.width).fill(''));
        for (const tile of data.tiles) {
            let symbol = '';
            switch(tile.type) {
                case 'start': symbol = 'S'; break;
                case 'goal': symbol = 'G'; break;
                case 'wall': symbol = '‚ñ†'; break;
                case 'floor': symbol = ''; break;
                default: symbol = '?';
            }
            map[tile.y][tile.x] = symbol;
        }
        // Entities auf die Map legen
        if (data.entities && Array.isArray(data.entities)) {
            for (const ent of data.entities) {
                let symbol = '';
                if (ent.type === 'player') symbol = 'üßë';
                else if (ent.type === 'opponent') symbol = 'üëæ';
                else if (ent.type === 'chest') symbol = 'üí∞';
                else symbol = '‚óè';
                map[ent.y][ent.x] = symbol;
            }
        }
        // Map als Tabelle rendern
        let html = '<b>Map</b><table class="map-table">';
        for (let y = 0; y < data.height; y++) {
            html += '<tr>';
            for (let x = 0; x < data.width; x++) {
                html += `<td>${map[y][x]}</td>`;
            }
            html += '</tr>';
        }
        html += '</table>';
        box.innerHTML = html;
    }
    window.onload = checkApiStatus;
    </script>
</body>
</html>
